<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Receipts - NEAR Protocol Specification</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Specification of the NEAR Protocol">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../README.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../Terminology.html"><strong aria-hidden="true">2.</strong> Terminology</a></li><li class="chapter-item expanded "><a href="../DataStructures/README.html"><strong aria-hidden="true">3.</strong> Data Structures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../DataStructures/Account.html"><strong aria-hidden="true">3.1.</strong> Account</a></li><li class="chapter-item expanded "><a href="../DataStructures/AccessKey.html"><strong aria-hidden="true">3.2.</strong> Access Key</a></li><li class="chapter-item expanded "><a href="../DataStructures/Transaction.html"><strong aria-hidden="true">3.3.</strong> Transaction</a></li></ol></li><li class="chapter-item expanded "><a href="../Architecture.html"><strong aria-hidden="true">4.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../ChainSpec/README.html"><strong aria-hidden="true">5.</strong> Chain specification</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ChainSpec/Consensus.html"><strong aria-hidden="true">5.1.</strong> Consensus</a></li><li class="chapter-item expanded "><a href="../ChainSpec/Upgradability.html"><strong aria-hidden="true">5.2.</strong> Upgradability</a></li><li class="chapter-item expanded "><a href="../ChainSpec/Transactions.html"><strong aria-hidden="true">5.3.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../ChainSpec/LightClient.html"><strong aria-hidden="true">5.4.</strong> Light Client</a></li></ol></li><li class="chapter-item expanded "><a href="../RuntimeSpec/README.html"><strong aria-hidden="true">6.</strong> Runtime specification</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../RuntimeSpec/Runtime.html"><strong aria-hidden="true">6.1.</strong> Runtime</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/FunctionCall.html"><strong aria-hidden="true">6.2.</strong> FunctionCall</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Transactions.html"><strong aria-hidden="true">6.3.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Actions.html"><strong aria-hidden="true">6.4.</strong> Actions</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Receipts.html" class="active"><strong aria-hidden="true">6.5.</strong> Receipts</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Refunds.html"><strong aria-hidden="true">6.6.</strong> Refunds</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Scenarios/Scenarios.html"><strong aria-hidden="true">6.7.</strong> Scenarios</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../RuntimeSpec/Scenarios/FinancialTransaction.html"><strong aria-hidden="true">6.7.1.</strong> Financial Transaction</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Scenarios/CrossContractCall.html"><strong aria-hidden="true">6.7.2.</strong> Cross-Contract Call</a></li></ol></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/Components.html"><strong aria-hidden="true">6.8.</strong> Components</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/RuntimeCrate.html"><strong aria-hidden="true">6.8.1.</strong> Runtime crate</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/BindingsSpec/BindingsSpec.html"><strong aria-hidden="true">6.8.2.</strong> Bindings Specification</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/BindingsSpec/RegistersAPI.html"><strong aria-hidden="true">6.8.2.1.</strong> Registers API</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/BindingsSpec/TrieAPI.html"><strong aria-hidden="true">6.8.2.2.</strong> Trie API</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/BindingsSpec/PromisesAPI.html"><strong aria-hidden="true">6.8.2.3.</strong> Promises API</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/BindingsSpec/ContextAPI.html"><strong aria-hidden="true">6.8.2.4.</strong> Context API</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/BindingsSpec/EconomicsAPI.html"><strong aria-hidden="true">6.8.2.5.</strong> Economics API</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/BindingsSpec/MathAPI.html"><strong aria-hidden="true">6.8.2.6.</strong> Math API</a></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/BindingsSpec/MiscellaneousAPI.html"><strong aria-hidden="true">6.8.2.7.</strong> Miscellaneous API</a></li></ol></li><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/Precompiles/README.html"><strong aria-hidden="true">6.8.3.</strong> Pre-compiles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../RuntimeSpec/Components/Precompiles/EVM.html"><strong aria-hidden="true">6.8.3.1.</strong> EVM</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../GenesisConfig/GenesisConfig.html"><strong aria-hidden="true">7.</strong> GenesisConfig</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../GenesisConfig/RuntimeConfig.html"><strong aria-hidden="true">7.1.</strong> RuntimeConfig</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../GenesisConfig/RuntimeFeeConfig.html"><strong aria-hidden="true">7.1.1.</strong> RuntimeFeeConfig</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../GenesisConfig/RuntimeFeeConfig/AccessKeyCreationConfig.html"><strong aria-hidden="true">7.1.1.1.</strong> AccessKeyCreationConfig</a></li><li class="chapter-item expanded "><a href="../GenesisConfig/RuntimeFeeConfig/ActionCreationConfig.html"><strong aria-hidden="true">7.1.1.2.</strong> ActionCreationConfig</a></li><li class="chapter-item expanded "><a href="../GenesisConfig/RuntimeFeeConfig/DataReceiptCreationConfig.html"><strong aria-hidden="true">7.1.1.3.</strong> DataReceiptCreationConfig</a></li><li class="chapter-item expanded "><a href="../GenesisConfig/RuntimeFeeConfig/StorageUsageConfig.html"><strong aria-hidden="true">7.1.1.4.</strong> StorageUsageConfig</a></li><li class="chapter-item expanded "><a href="../GenesisConfig/RuntimeFeeConfig/Fee.html"><strong aria-hidden="true">7.1.1.5.</strong> Fee</a></li><li class="chapter-item expanded "><a href="../GenesisConfig/RuntimeFeeConfig/Fraction.html"><strong aria-hidden="true">7.1.1.6.</strong> Fraction</a></li></ol></li><li class="chapter-item expanded "><a href="../GenesisConfig/VMConfig.html"><strong aria-hidden="true">7.1.2.</strong> VMConfig</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../GenesisConfig/ExtCostsConfig.html"><strong aria-hidden="true">7.1.2.1.</strong> ExtCostsConfig</a></li></ol></li><li class="chapter-item expanded "><a href="../GenesisConfig/StateRecord.html"><strong aria-hidden="true">7.1.3.</strong> StateRecord</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../Economics/README.html"><strong aria-hidden="true">8.</strong> Economics</a></li><li class="chapter-item expanded "><a href="../Standards/README.html"><strong aria-hidden="true">9.</strong> Standards</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Standards/Tokens/FungibleToken.html"><strong aria-hidden="true">9.1.</strong> Fungible Token</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">NEAR Protocol Specification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#receipt" id="receipt">Receipt</a></h1>
<p>All cross-contract (we assume that each account lives in it's own shard) communication in Near happens trough Receipts.
Receipts are stateful in a sense that they serve not only as messages between accounts but also can be stored in the account storage to await DataReceipts.</p>
<p>Each receipt has a <a href="#predecessor_id"><code>predecessor_id</code></a> (who sent it) and <a href="#receiver_id"><code>receiver_id</code></a> the current account.</p>
<p>Receipts are one of 2 types: action receipts or data receipts.</p>
<p>Data Receipts are receipts that contains some data for some <code>ActionReceipt</code> with the same <code>receiver_id</code>.
Data Receipts has 2 fields: the unique data identifier <code>data_id</code> and <code>data</code> the received result.
<code>data</code> is an <code>Option</code> field and it indicates whether the result was a success or a failure. If it's <code>Some</code>, then it means
the remote execution was successful and it contains the vector of bytes of the result.</p>
<p>Each <code>ActionReceipt</code> also contains fields related to data:</p>
<ul>
<li><a href="#input_data_ids"><code>input_data_ids</code></a> - a vector of input data with the <code>data_id</code>s required for the execution of this receipt.</li>
<li><a href="#output_data_receivers"><code>output_data_receivers</code></a> - a vector of output data receivers. It indicates where to send outgoing data.
Each <code>DataReceiver</code> consists of <code>data_id</code> and <code>receiver_id</code> for routing.</li>
</ul>
<p>Before any action receipt is executed, all input data dependencies need to be satisfied.
Which means all corresponding data receipts has to be received.
If any of the data dependencies is missing, the action receipt is postponed until all missing data dependency arrives.</p>
<p>Because Chain and Runtime guarantees that no receipts are missing, we can rely that every action receipt will be executed eventually (<a href="#receipt-matching">Receipt Matching explanation</a>).</p>
<p>Each <code>Receipt</code> has the following fields:</p>
<h4><a class="header" href="#predecessor_id" id="predecessor_id">predecessor_id</a></h4>
<ul>
<li><strong><code>type</code></strong>: <code>AccountId</code></li>
</ul>
<p>The account_id which issued a receipt.
In case of a gas or deposit refund, the account ID is <code>system</code>.</p>
<h4><a class="header" href="#receiver_id" id="receiver_id">receiver_id</a></h4>
<ul>
<li><strong><code>type</code></strong>: <code>AccountId</code></li>
</ul>
<p>The destination account_id.</p>
<h4><a class="header" href="#receipt_id" id="receipt_id">receipt_id</a></h4>
<ul>
<li><strong><code>type</code></strong>: <code>AccountId</code></li>
</ul>
<p>An unique id for the receipt.</p>
<h4><a class="header" href="#receipt-1" id="receipt-1">receipt</a></h4>
<ul>
<li><strong><code>type</code></strong>: <a href="#actionreceipt">ActionReceipt</a> | <a href="#datareceipt">DataReceipt</a></li>
</ul>
<p>There is a 2 types of Receipts: <a href="#actionreceipt">ActionReceipt</a> and <a href="#datareceipt">DataReceipt</a>. ActionReceipt is a request to apply <a href="Actions.html">Actions</a>, while DataReceipt is a result of application of these actions.</p>
<h2><a class="header" href="#actionreceipt" id="actionreceipt">ActionReceipt</a></h2>
<p><code>ActionReceipt</code> represents a request to apply actions on the <code>receiver_id</code> side. It could be a derived as a result of a <code>Transaction</code> execution or a another <code>ActionReceipt</code> processing. <code>ActionReceipt</code> consists the following fields:</p>
<h4><a class="header" href="#signer_id" id="signer_id">signer_id</a></h4>
<ul>
<li><strong><code>type</code></strong>: <code>AccountId</code></li>
</ul>
<p>An account_id which signed the original <a href="Transaction.html">transaction</a>.
In case of a deposit refund, the account ID is <code>system</code>.</p>
<h4><a class="header" href="#signer_public_key" id="signer_public_key">signer_public_key</a></h4>
<ul>
<li><strong><code>type</code></strong>: <code>PublicKey</code></li>
</ul>
<p>The public key of an <a href="../Primitives/AccessKey.html">AccessKey</a> which was used to sign the original transaction.
In case of a deposit refund, the public key is empty (all bytes are 0).</p>
<h4><a class="header" href="#gas_price" id="gas_price">gas_price</a></h4>
<ul>
<li><strong><code>type</code></strong>: <code>u128</code></li>
</ul>
<p>Gas price is a gas price which was set in a block where original <a href="Transaction.html">transaction</a> has been applied.</p>
<h4><a class="header" href="#output_data_receivers" id="output_data_receivers">output_data_receivers</a></h4>
<ul>
<li><strong><code>type</code></strong>: <code>[DataReceiver{ data_id: CryptoHash, receiver_id: AccountId }]</code></li>
</ul>
<p>If smart contract finishes its execution with some value (not Promise), runtime creates a [<code>DataReceipt</code>]s for each of the <code>output_data_receivers</code>.</p>
<h4><a class="header" href="#input_data_ids" id="input_data_ids">input_data_ids</a></h4>
<ul>
<li><strong><code>type</code></strong>: <code>[CryptoHash]_</code></li>
</ul>
<p><code>input_data_ids</code> are the receipt data dependencies. <code>input_data_ids</code> correspond to <code>DataReceipt.data_id</code>.</p>
<h4><a class="header" href="#actions" id="actions">actions</a></h4>
<ul>
<li><strong><code>type</code></strong>: <a href="Actions.html#functioncallaction"><code>FunctionCall</code></a> | <a href="Actions.html#transferaction"><code>TransferAction</code></a> | <a href="Actions.html#stakeaction"><code>StakeAction</code></a> | <a href="Actions.html#addkeyaction"><code>AddKeyAction</code></a> | <a href="Actions.html#deletekeyaction"><code>DeleteKeyAction</code></a> | <a href="Actions.html#createaccountaction"><code>CreateAccountAction</code></a> | <a href="Actions.html#deleteaccountaction"><code>DeleteAccountAction</code></a></li>
</ul>
<h2><a class="header" href="#datareceipt" id="datareceipt">DataReceipt</a></h2>
<p>DataReceipt represents a final result of some contract execution.</p>
<h4><a class="header" href="#data_id" id="data_id">data_id</a></h4>
<ul>
<li><strong><code>type</code></strong>: <code>CryptoHash</code></li>
</ul>
<p>An a unique DataReceipt identifier.</p>
<h4><a class="header" href="#data" id="data">data</a></h4>
<ul>
<li><strong><code>type</code></strong>: <code>Option([u8])</code></li>
</ul>
<p>An an associated data in bytes. <code>None</code> indicates an error during execution.</p>
<h1><a class="header" href="#creating-receipt" id="creating-receipt">Creating Receipt</a></h1>
<p>Receipts can be generated during the execution of the <a href="./Transactions.html#SignedTransaction">SignedTransaction</a> (see <a href="./Scenarios/FinancialTransaction.html">example</a>) or during application of some <code>ActionReceipt</code> which contains <a href="#actions"><code>FunctionCall</code></a> action. The result of the <code>FunctionCall</code> could either</p>
<h1><a class="header" href="#receipt-matching" id="receipt-matching">Receipt Matching</a></h1>
<p>Runtime doesn't expect that Receipts are coming in a particular order. Each Receipt is processed individually. The goal of the <code>Receipt Matching</code> process is to match all <a href="#actionreceipt"><code>ActionReceipt</code>s</a> to the corresponding <a href="#datareceipt"><code>DataReceipt</code>s</a>.</p>
<h2><a class="header" href="#processing-actionreceipt" id="processing-actionreceipt">Processing ActionReceipt</a></h2>
<p>For each incoming <a href="#actionreceipt"><code>ActionReceipt</code></a> runtime checks whether we have all the <a href="#datareceipt"><code>DataReceipt</code>s</a> (defined as <a href="#input_data_ids"><code>ActionsReceipt.input_data_ids</code></a>) required for execution. If all the required <a href="#datareceipt"><code>DataReceipt</code>s</a> are already in the <a href="#received-datareceipt">storage</a>, runtime can apply this <code>ActionReceipt</code> immediately. Otherwise we save this receipt as a <a href="#postponed-actionreceipt">Postponed ActionReceipt</a>. Also we save <a href="#pending-datareceipt-count">Pending DataReceipts Count</a> and <a href="#pending-datareceipt-for-postponed-actionreceipt">a link from pending <code>DataReceipt</code> to the <code>Postponed ActionReceipt</code></a>. Now runtime will wait all the missing <code>DataReceipt</code>s to apply the <code>Postponed ActionReceipt</code>.</p>
<h4><a class="header" href="#postponed-actionreceipt" id="postponed-actionreceipt">Postponed ActionReceipt</a></h4>
<p>A Receipt which runtime stores until all the designated <a href="#datareceipt"><code>DataReceipt</code>s</a> arrive.</p>
<ul>
<li><strong><code>key</code></strong> = <code>account_id</code>,<code>receipt_id</code></li>
<li><strong><code>value</code></strong> = <code>[u8]</code></li>
</ul>
<p><em>Where <code>account_id</code> is <a href="#receiver_id"><code>Receipt.receiver_id</code></a>, <code>receipt_id</code> is <a href="#receipt_id"><code>Receipt.receiver_id</code></a> and value is a serialized <a href="#receipt"><code>Receipt</code></a> (which <a href="#type">type</a> must be <a href="#actionreceipt">ActionReceipt</a>).</em></p>
<h4><a class="header" href="#pending-datareceipt-count" id="pending-datareceipt-count">Pending DataReceipt Count</a></h4>
<p>A counter which counts pending <a href="#DataReceipt"><code>DataReceipt</code>s</a> for a <a href="#postponed-receipt">Postponed Receipt</a> initially set to the length of missing <a href="#input_data_ids"><code>input_data_ids</code></a> of the incoming <code>ActionReceipt</code>. It's decrementing with every new received <a href="#datareceipt"><code>DataReceipt</code></a>:</p>
<ul>
<li><strong><code>key</code></strong> = <code>account_id</code>,<code>receipt_id</code></li>
<li><strong><code>value</code></strong> = <code>u32</code></li>
</ul>
<p><em>Where <code>account_id</code> is AccountId, <code>receipt_id</code> is CryptoHash and value is an integer.</em></p>
<h4><a class="header" href="#pending-datareceipt-for-postponed-actionreceipt" id="pending-datareceipt-for-postponed-actionreceipt">Pending DataReceipt for Postponed ActionReceipt</a></h4>
<p>We index each pending <code>DataReceipt</code> so when a new <a href="#datareceipt"><code>DataReceipt</code></a> arrives we can find to which <a href="#postponed-receipt">Postponed Receipt</a> it belongs.</p>
<ul>
<li><strong><code>key</code></strong> = <code>account_id</code>,<code>data_id</code></li>
<li><strong><code>value</code></strong> = <code>receipt_id</code></li>
</ul>
<h2><a class="header" href="#processing-datareceipt" id="processing-datareceipt">Processing DataReceipt</a></h2>
<h4><a class="header" href="#received-datareceipt" id="received-datareceipt">Received DataReceipt</a></h4>
<p>First of all, runtime saves the incoming <code>DataReceipt</code> to the storage as:</p>
<ul>
<li><strong><code>key</code></strong> = <code>account_id</code>,<code>data_id</code></li>
<li><strong><code>value</code></strong> = <code>[u8]</code></li>
</ul>
<p><em>Where <code>account_id</code> is <a href="#receiver_id"><code>Receipt.receiver_id</code></a>, <code>data_id</code> is <a href="#data_id"><code>DataReceipt.data_id</code></a> and value is a <a href="#data"><code>DataReceipt.data</code></a> (which is typically a serialized result of the call to a particular contract).</em></p>
<p>Next, runtime checks if there is any <a href="#postponed-actionreceipt"><code>Postponed ActionReceipt</code></a> awaits for this <code>DataReceipt</code> by querying <a href="#pending-datareceipt-for-postponed-actionReceipt"><code>Pending DataReceipt</code> to the Postponed Receipt</a>. If there is no postponed <code>receipt_id</code> yet, we do nothing else. If there is a postponed <code>receipt_id</code>, we do the following:</p>
<ul>
<li>decrement <a href="#pending-datareceipt-count"><code>Pending Data Count</code></a> for the postponed <code>receipt_id</code></li>
<li>remove found <a href="#pending-datareceipt-for-postponed-actionreceipt"><code>Pending DataReceipt</code> to the <code>Postponed ActionReceipt</code></a></li>
</ul>
<p>If <a href="#pending-datareceipt-count"><code>Pending DataReceipt Count</code></a> is now 0 that means all the <a href="#input_data_ids"><code>Receipt.input_data_ids</code></a> are in storage and runtime can safely apply the <a href="#postponed-receipt">Postponed Receipt</a> and remove it from the store.</p>
<h2><a class="header" href="#case-1-call-to-multiple-contracts-and-await-responses" id="case-1-call-to-multiple-contracts-and-await-responses">Case 1: Call to multiple contracts and await responses</a></h2>
<p>Suppose runtime got the following <code>ActionReceipt</code>:</p>
<pre><code class="language-python"># Non-relevant fields are omitted.
Receipt{
    receiver_id: &quot;alice&quot;,
    receipt_id: &quot;693406&quot;
    receipt: ActionReceipt {
        input_data_ids: []
    }
}
</code></pre>
<p>If execution return Result::Value</p>
<p>Suppose runtime got the following <code>ActionReceipt</code> (we use a python-like pseudo code):</p>
<pre><code class="language-python"># Non-relevant fields are omitted.
Receipt{
    receiver_id: &quot;alice&quot;,
    receipt_id: &quot;5e73d4&quot;
    receipt: ActionReceipt {
        input_data_ids: [&quot;e5fa44&quot;, &quot;7448d8&quot;]
    }
}
</code></pre>
<p>We can't apply this receipt right away: there are missing DataReceipt'a with IDs: [&quot;e5fa44&quot;, &quot;7448d8&quot;]. Runtime does the following:</p>
<pre><code class="language-python">postponed_receipts[&quot;alice,5e73d4&quot;] = borsh_serialize(
    Receipt{
        receiver_id: &quot;alice&quot;,
        receipt_id: &quot;5e73d4&quot;
        receipt: ActionReceipt {
            input_data_ids: [&quot;e5fa44&quot;, &quot;7448d8&quot;]
        }
    }
)
pending_data_receipt_store[&quot;alice,e5fa44&quot;] = &quot;5e73d4&quot;
pending_data_receipt_store[&quot;alice,7448d8&quot;] = &quot;5e73d4&quot;
pending_data_receipt_count = 2
</code></pre>
<p><em>Note: the subsequent Receipts could arrived in the current block or next, that's why we save <a href="#postponed-actionreceipt">Postponed ActionReceipt</a> in the storage</em></p>
<p>Then the first pending <code>Pending DataReceipt</code> arrives:</p>
<pre><code class="language-python"># Non-relevant fields are omitted.
Receipt {
    receiver_id: &quot;alice&quot;,
    receipt: DataReceipt {
        data_id: &quot;e5fa44&quot;,
        data: &quot;some data for alice&quot;,
    }
}
</code></pre>
<pre><code class="language-python">data_receipts[&quot;alice,e5fa44&quot;] = borsh_serialize(Receipt{
    receiver_id: &quot;alice&quot;,
    receipt: DataReceipt {
        data_id: &quot;e5fa44&quot;,
        data: &quot;some data for alice&quot;,
    }
};
pending_data_receipt_count[&quot;alice,5e73d4&quot;] = 1`
del pending_data_receipt_store[&quot;alice,e5fa44&quot;]
</code></pre>
<p>And finally the last <code>Pending DataReceipt</code> arrives:</p>
<pre><code class="language-python"># Non-relevant fields are omitted.
Receipt{
    receiver_id: &quot;alice&quot;,
    receipt: DataReceipt {
        data_id: &quot;7448d8&quot;,
        data: &quot;some more data for alice&quot;,
    }
}
</code></pre>
<pre><code class="language-python">data_receipts[&quot;alice,7448d8&quot;] = borsh_serialize(Receipt{
    receiver_id: &quot;alice&quot;,
    receipt: DataReceipt {
        data_id: &quot;7448d8&quot;,
        data: &quot;some more data for alice&quot;,
    }
};
postponed_receipt_id = pending_data_receipt_store[&quot;alice,5e73d4&quot;]
postponed_receipt = postponed_receipts[postponed_receipt_id]
del postponed_receipts[postponed_receipt_id]
del pending_data_receipt_count[&quot;alice,5e73d4&quot;]
del pending_data_receipt_store[&quot;alice,7448d8&quot;]
apply_receipt(postponed_receipt)
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../RuntimeSpec/Actions.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../RuntimeSpec/Refunds.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../RuntimeSpec/Actions.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../RuntimeSpec/Refunds.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
